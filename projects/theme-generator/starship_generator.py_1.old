#!/usr/bin/env python3

import os
import re
import shutil
from pathlib import Path

def format_palette_name(theme_name):
    """Convert theme folder name to proper palette name format."""
    # Convert kebab-case to PascalCase with underscores
    parts = theme_name.split('-')
    formatted = ''.join(part.title() for part in parts)
    # Replace underscores if any and handle multiple separators
    formatted = formatted.replace('_', '')
    
    # Special replacements for known patterns
    formatted = formatted.replace('Light', '_Light')
    formatted = formatted.replace('Dark', '_Dark')
    formatted = formatted.replace('Darker', '_Darker')
    
    # Ensure we don't have double underscores
    formatted = formatted.replace('__', '_')
    
    # Remove leading/trailing underscores
    formatted = formatted.strip('_')
    
    return formatted

def backup_starship_config(starship_path):
    """Backup existing starship.toml if it exists."""
    if starship_path.exists():
        backup_path = starship_path.parent / f"starship.toml.backup.{int(os.path.getmtime(starship_path))}"
        shutil.copy2(starship_path, backup_path)
        print(f"âœ“ Backed up existing starship.toml to {backup_path}")
        return True
    return False

def copy_template(template_path, destination_path):
    """Copy template starship.toml to config directory."""
    try:
        shutil.copy2(template_path, destination_path)
        print(f"âœ“ Copied template from {template_path} to {destination_path}")
        return True
    except Exception as e:
        print(f"âœ— Error copying template: {e}")
        return False

def extract_color_definitions(tmux_colors_path):
    """Extract color definitions from a tmux-colors.conf file."""
    try:
        with open(tmux_colors_path, 'r') as f:
            content = f.read()
        
        # Pattern to match color definitions (handles both = and space, with or without quotes)
        color_pattern = r'(\w+)\s*[=:]\s*"?(#[\da-fA-F]{6})"?'
        colors = dict(re.findall(color_pattern, content))
        
        # Filter for the specific colors we want
        target_colors = [
            "base", "text", "crust", "sig1", "sig2", "on_sig1", "on_sig2",
            "on_sigbg", "sig_bg", "sig_surface_high", "red"
        ]
        
        extracted = {}
        for color_name in target_colors:
            if color_name in colors:
                extracted[color_name] = colors[color_name]
            else:
                # Try to find similar patterns
                for key in colors.keys():
                    if color_name in key or key in color_name:
                        extracted[color_name] = colors[key]
                        break
        
        return extracted
    except Exception as e:
        print(f"  âœ— Error reading {tmux_colors_path}: {e}")
        return {}

def find_theme_folders(themes_dir):
    """Find all theme folders containing tmux-colors.conf."""
    themes = []
    themes_dir = Path(themes_dir)
    
    if not themes_dir.exists():
        print(f"âœ— Themes directory not found: {themes_dir}")
        return themes
    
    for item in themes_dir.iterdir():
        if item.is_dir():
            tmux_colors_path = item / "tmux-colors.conf"
            if tmux_colors_path.exists():
                themes.append((item.name, tmux_colors_path))
    
    return themes

def add_palette_to_starship(starship_path, theme_name, color_definitions):
    """Add a palette section to starship.toml."""
    if not color_definitions:
        return False
    
    palette_name = format_palette_name(theme_name)
    
    # Read current content
    with open(starship_path, 'r') as f:
        content = f.read()
    
    # Remove any existing palette entry for this theme
    pattern = rf'\[palettes\.{re.escape(palette_name)}\](.*?)(?=\n\[|\Z)'
    content = re.sub(pattern, '', content, flags=re.DOTALL)
    
    # Add new palette at the end
    palette_section = f"\n\n[palettes.{palette_name}]\n"
    for color_name, color_value in sorted(color_definitions.items()):
        palette_section += f'{color_name} = "{color_value}"\n'
    
    # Append to file
    with open(starship_path, 'a') as f:
        f.write(palette_section)
    
    return True

def main():
    # Define paths
    home_dir = Path.home()
    dotfiles_dir = home_dir / "dotfiles"
    themes_dir = dotfiles_dir / "themes"
    template_path = dotfiles_dir / "projects" / "templates" / "starship.toml"
    starship_path = home_dir / ".config" / "starship.toml"
    
    print("ðŸŽ¨ Starship Palette Generator")
    print("=" * 40)
    
    # Step 1: Backup existing starship.toml
    print("\n1. Backing up existing config...")
    backed_up = backup_starship_config(starship_path)
    
    # Step 2: Copy template
    print("\n2. Copying template...")
    if not template_path.exists():
        print(f"âœ— Template not found: {template_path}")
        return
    
    if not copy_template(template_path, starship_path):
        return
    
    # Step 3: Find theme folders
    print("\n3. Finding themes...")
    themes = find_theme_folders(themes_dir)
    
    if not themes:
        print("âœ— No theme folders with tmux-colors.conf found!")
        return
    
    print(f"   Found {len(themes)} theme(s):")
    for theme_name, _ in themes:
        print(f"   â€¢ {theme_name}")
    
    # Step 4: Extract colors and add palettes
    print("\n4. Extracting colors and creating palettes...")
    success_count = 0
    
    for theme_name, tmux_colors_path in themes:
        print(f"   Processing {theme_name}...")
        
        color_definitions = extract_color_definitions(tmux_colors_path)
        
        if color_definitions:
            palette_name = format_palette_name(theme_name)
            if add_palette_to_starship(starship_path, theme_name, color_definitions):
                print(f"     âœ“ Added palette '{palette_name}' with {len(color_definitions)} colors")
                success_count += 1
            else:
                print(f"     âœ— Failed to add palette for {theme_name}")
        else:
            print(f"     âœ— No color definitions found for {theme_name}")
    
    # Step 5: Summary
    print("\n" + "=" * 40)
    print("ðŸŽ‰ Summary")
    print(f"   â€¢ Themes processed: {len(themes)}")
    print(f"   â€¢ Palettes created: {success_count}")
    
    if backed_up:
        print(f"   â€¢ Backup created: starship.toml.backup.*")
    
    print(f"   â€¢ New config: {starship_path}")
    
    # Show example of how to use palettes in starship.toml
    print("\nðŸ’¡ Usage Tip:")
    print("   To use a palette in starship.toml, add this to your [format] section:")
    print("   palette = \"Everforest_Dark\"  # or any palette name created above")
    print("\n   Available palettes:")
    for theme_name, _ in themes:
        palette_name = format_palette_name(theme_name)
        print(f"   â€¢ {palette_name}")

if __name__ == "__main__":
    main()
