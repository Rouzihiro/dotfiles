#!/usr/bin/env bash

set -euo pipefail

echo ">>> Checking/creating 8 GB swapfile..."
if [ ! -f /swapfile ]; then
    echo "Creating swapfile with dd..."
    sudo dd if=/dev/zero of=/swapfile bs=1M count=8192 status=progress
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
else
    echo "Swapfile already exists — skipping creation."
fi

echo ">>> Applying sysctl tuning for zswap + swap usage..."
sudo tee -a /etc/sysctl.d/99-zswap.conf >/dev/null <<'EOF'
# Lower swappiness to avoid swapping too aggressively
vm.swappiness=10
# Reduce VFS cache pressure slightly
vm.vfs_cache_pressure=50
EOF
sudo sysctl --system >/dev/null

echo ">>> Enabling zswap via kernel parameters..."
echo "Please ensure your kernel cmdline contains:"
echo "  zswap.enabled=1 zswap.compressor=zstd zswap.max_pool_percent=20 zswap.zpool=z3fold"
echo "Check with: cat /proc/cmdline"
echo
echo ">>> Current swap setup:"
swapon --show
echo
echo ">>> Zswap status (requires root):"
sudo cat /sys/kernel/debug/zswap/* 2>/dev/null || echo "Zswap debug info not available (may need debugfs mounted)"
echo
echo "✅ Swap + zswap successfully configured. Reboot to fully apply kernel zswap settings."
