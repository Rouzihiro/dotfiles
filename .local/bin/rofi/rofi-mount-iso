#!/bin/sh

# Set mount point and theme
MOUNT_POINT="$HOME/mount/iso"
ROFI_THEME="$HOME/.config/rofi/topbox.rasi"

# Function to mount ISO
mount_iso() {
    local iso_path="$1"
    
    if [ ! -f "$iso_path" ]; then
        notify-send "ISO Mount" "Error: File '$iso_path' does not exist." -u critical
        exit 1
    fi

    mkdir -p "$MOUNT_POINT"

    if sudo mount -o loop "$iso_path" "$MOUNT_POINT"; then
        notify-send "ISO Mount" "Successfully mounted $(basename "$iso_path") to $MOUNT_POINT" -u normal
    else
        notify-send "ISO Mount" "Failed to mount $(basename "$iso_path")" -u critical
    fi
}

# Function to unmount ISO
unmount_iso() {
    if mountpoint -q "$MOUNT_POINT"; then
        if sudo umount "$MOUNT_POINT"; then
            notify-send "ISO Unmount" "Successfully unmounted ISO from $MOUNT_POINT" -u normal
        else
            notify-send "ISO Unmount" "Failed to unmount ISO" -u critical
        fi
    else
        notify-send "ISO Unmount" "No ISO is currently mounted at $MOUNT_POINT" -u normal
    fi
}

# Function to check status
check_status() {
    if mountpoint -q "$MOUNT_POINT"; then
        local mount_info
        mount_info=$(mount | grep "$MOUNT_POINT")
        rofi -config "$ROFI_THEME" -e "ðŸ“¡ Status: ISO is mounted\nðŸ“ Mount point: $MOUNT_POINT\nðŸ”— Details: $mount_info"
    else
        rofi -config "$ROFI_THEME" -e "ðŸ“¡ Status: No ISO mounted\nðŸ“ Mount point: $MOUNT_POINT"
    fi
}

# Function with advanced file browser (if fzf is available)
browse_iso_advanced() {
    if command -v fzf >/dev/null 2>&1; then
        local iso_file
        iso_file=$(find "$HOME" -type f \( -name "*.iso" -o -name "*.ISO" \) 2>/dev/null | fzf --height 40% --border --prompt="Select ISO: ")
        
        if [ -n "$iso_file" ]; then
            mount_iso "$iso_file"
        fi
    else
        # Fallback to simple file selection
        local iso_file
        iso_file=$(find "$HOME" -type f \( -name "*.iso" -o -name "*.ISO" \) 2>/dev/null | rofi -config "$ROFI_THEME" -dmenu -p "Select ISO:")
        [ -n "$iso_file" ] && mount_iso "$iso_file"
    fi
}

# Function to show recent ISOs (last 10 accessed)
show_recent_isos() {
    local recent_iso
    recent_iso=$(find "$HOME" -type f \( -name "*.iso" -o -name "*.ISO" \) -exec ls -lt --time=atime {} + 2>/dev/null | head -10 | awk '{print $9}' | rofi -config "$ROFI_THEME" -dmenu -p "Recent ISOs:" -i)
    
    if [ -n "$recent_iso" ]; then
        mount_iso "$recent_iso"
    fi
}

# Enhanced main menu
show_main_menu() {
    local choice
    choice=$(echo -e "ðŸ“ Mount ISO (Enter Path)\nðŸ” Browse and Mount\nðŸ•’ Recent ISOs\nâï¸ Unmount ISO\nâ„¹ï¸ Check Status\nâŒ Exit" | rofi -config "$ROFI_THEME" -dmenu -p "ISO Manager" -i)
    
    case "$choice" in
        *"Enter Path"*)
            local iso_path
            iso_path=$(rofi -config "$ROFI_THEME" -dmenu -p "Enter ISO path:")
            [ -n "$iso_path" ] && mount_iso "$iso_path"
            ;;
        *"Browse"*)
            browse_iso_advanced
            ;;
        *"Recent"*)
            show_recent_isos
            ;;
        *"Unmount"*)
            unmount_iso
            ;;
        *"Check Status"*)
            check_status
            ;;
        *"Exit"*)
            exit 0
            ;;
    esac
}

# Make sure rofi is installed
if ! command -v rofi >/dev/null 2>&1; then
    echo "Error: rofi is not installed. Please install it first."
    exit 1
fi

# Main execution
if [ -n "$1" ]; then
    mount_iso "$1"
else
    while true; do
        show_main_menu
        # Small delay to prevent rapid re-opening
        sleep 0.5
    done
fi
