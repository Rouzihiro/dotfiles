#!/usr/bin/env bash

THEMES_DIR="$HOME/.config/zorro/themes/"
CURRENT_THEME_DIR="$HOME/.config/zorro/current/theme"
PALETTES_DIR="$HOME/Pictures/color-palettes"
CACHE_DIR="$HOME/.cache/theme-palette-thumbnails"

# Create cache directory if it doesn't exist
mkdir -p "$CACHE_DIR"

# Generate thumbnails for theme palettes
generate_palette_thumbnails() {
    find -L "$PALETTES_DIR" -type f -iname "*.png" | while read -r palette; do
        filename=$(basename "$palette")
        thumbnail="$CACHE_DIR/${filename%.*}.png"

        # Only generate if thumbnail doesn't exist or is older than original
        if [ ! -f "$thumbnail" ] || [ "$palette" -nt "$thumbnail" ]; then
            if command -v magick &> /dev/null; then
                magick "$palette" -resize 200x200^ -gravity center -extent 200x200 +adjoin "$thumbnail" 2>/dev/null
            elif command -v convert &> /dev/null; then
                convert "$palette" -resize 200x200^ -gravity center -extent 200x200 +adjoin "$thumbnail" 2>/dev/null
            fi
        fi
    done
}

# Check if ImageMagick is installed and generate thumbnails
if command -v magick &> /dev/null || command -v convert &> /dev/null; then
    generate_palette_thumbnails &
    # Wait for thumbnails to generate
    wait
fi

# Build rofi entries with palette previews
build_menu() {
    find "$THEMES_DIR" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) | sort | while read -r theme_path; do
        theme_name=$(basename "$theme_path")
        display_name=$(echo "$theme_name" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')
        
        # Look for palette thumbnail
        palette_thumbnail="$CACHE_DIR/$theme_name.png"
        
        if [ -f "$palette_thumbnail" ]; then
            printf "%s\0icon\x1f%s\n" "$display_name" "$palette_thumbnail"
        else
            echo "$display_name"
        fi
    done
}

# Get current theme for highlighting
get_current_theme() {
    if [ -L "$CURRENT_THEME_DIR" ]; then
        basename "$(readlink "$CURRENT_THEME_DIR")"
    fi
}

# Show rofi menu with palette previews
CURRENT_THEME=$(get_current_theme)
SELECTED_THEME=$(build_menu | rofi -dmenu -i -p "Select Theme" -show-icons \
    -theme ~/.config/rofi/grid-small.rasi \
    -theme-str 'element-icon { size: 6em; }' \
    -me-select-entry '' \
    -me-accept-entry MousePrimary 2>/dev/null)

[ -z "$SELECTED_THEME" ] && exit

# Normalize to directory name
THEME_NAME_NORMALIZED=$(echo "$SELECTED_THEME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
THEME_PATH="$THEMES_DIR/$THEME_NAME_NORMALIZED"

if [[ ! -d "$THEME_PATH" ]]; then
    notify-send -a "Theme" "Error" "Theme '$THEME_NAME_NORMALIZED' does not exist" -i dialog-error
    exit 2
fi

echo "Switching to theme: $SELECTED_THEME"

# Core theme setup only
ln -nsf "$THEME_PATH" "$CURRENT_THEME_DIR"

# Quick restarts (non-blocking)
z-theme-bg-next &
z-theme-bat &
tmux source-file ~/.config/tmux/tmux.conf &
z-restart waybar &
pkill -SIGUSR2 btop &
z-theme-set-starship
z-theme-set-gtk
$HOME/.config/zorro/current/theme/gtk.sh

# Show notification with palette preview if available
PALETTE_PREVIEW="$PALETTES_DIR/$THEME_NAME_NORMALIZED.png"
if [ -f "$PALETTE_PREVIEW" ]; then
    notify-send -a "Theme" "Theme Changed" "Switched to $SELECTED_THEME" -i "$PALETTE_PREVIEW"
else
    notify-send -a "Theme" "Theme Changed" "Switched to $SELECTED_THEME" -i preferences-desktop-theme
fi

echo "Theme base setup completed: $SELECTED_THEME"
echo "Run 'z-theme-set-gtk' to apply GTK settings"
