#!/usr/bin/env bash

THEMES_DIR="$HOME/.config/zorro/themes/"
CURRENT_THEME_DIR="$HOME/.config/zorro/current/theme"

# Get current theme
current_theme=""
if [ -L "$CURRENT_THEME_DIR" ]; then
    current_theme=$(basename "$(readlink "$CURRENT_THEME_DIR")")
    current_theme=$(echo "$current_theme" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')
fi

# Build menu with icons and current theme indication
menu=()

# Use a temporary file to store the menu items
temp_file=$(mktemp)

# Generate theme list with current theme marked
find "$THEMES_DIR" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) | sort | while read -r path; do
    # Check if it's a symlink and get the actual target
    if [ -L "$path" ]; then
        target=$(readlink -f "$path")
        theme_name=$(basename "$target")
        display_name=$(echo "$theme_name" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')
        icon="󰈏"  # Chain icon for symlinks
    else
        theme_name=$(basename "$path")
        display_name=$(echo "$theme_name" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')
        icon="󰄮"  # Folder icon for regular themes
    fi
    
    if [ "$display_name" = "$current_theme" ]; then
        echo "$icon $display_name (Active)" >> "$temp_file"
    else
        echo "$icon $display_name" >> "$temp_file"
    fi
done

# Read the temp file into the menu array
while IFS= read -r line; do
    menu+=("$line")
done < "$temp_file"

# Clean up
rm -f "$temp_file"

# Show rofi menu
selected=$(printf '%s\n' "${menu[@]}" | rofi -dmenu -i -p "Select Theme")

# Handle selection
if [ -n "$selected" ]; then
    # Extract theme name (remove icon and active status)
    theme_display_name=$(echo "$selected" | sed 's/^[^ ]* //' | sed 's/ (Active)//')
    
    # Normalize to directory name
    theme_name_normalized=$(echo "$theme_display_name" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
    theme_path="$THEMES_DIR/$theme_name_normalized"

    # Check if theme exists (follow symlinks)
    if [[ ! -e "$theme_path" ]]; then
        notify-send -a "Theme" "Error" "Theme '$theme_display_name' does not exist" -i dialog-error
        exit 2
    fi

    # Switch theme
    ln -nsf "$theme_path" "$CURRENT_THEME_DIR"

    # Rename .themes symlink
    if [[ -d "$HOME/.themes" ]]; then
        SYMLINK_PATH=$(find "$HOME/.themes" -maxdepth 1 -type l | head -n 1)
        
        if [[ -n "$SYMLINK_PATH" ]]; then
            # Get actual theme name (follow symlink if needed)
            if [ -L "$theme_path" ]; then
                ACTUAL_THEME_NAME=$(basename "$(readlink -f "$theme_path")")
            else
                ACTUAL_THEME_NAME=$(basename "$theme_path")
            fi
            CAPITALIZED_THEME=$(echo "$ACTUAL_THEME_NAME" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-//g')
            NEW_NAME="$HOME/.themes/${CAPITALIZED_THEME}-Dark"
            mv "$SYMLINK_PATH" "$NEW_NAME"
        fi
    fi

    # Quick restarts (non-blocking)
    z-theme-bg-next &
    z-theme-bat &
    tmux source-file ~/.config/tmux/tmux.conf &
    z-restart waybar &
    pkill -SIGUSR2 btop &

    notify-send -a "Theme" "Theme Changed" "Switched to $theme_display_name" -i preferences-desktop-theme
    echo "Theme base setup completed: $theme_display_name"
    echo "Run 'z-theme-set-gtk' to apply GTK settings"
fi
