#!/usr/bin/env bash

THEMES_DIR="$HOME/.config/zorro/themes/"
CURRENT_THEME_DIR="$HOME/.config/zorro/current/theme"

# Show theme selection with Wofi
THEME_NAME=$(find "$THEMES_DIR" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) | sort | \
  while read -r path; do
    echo "$(basename "$path" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')"
  done | wofi --dmenu --prompt "Select GTK Theme" --lines 10)

[ -z "$THEME_NAME" ] && exit

# Normalize theme name
THEME_NAME_NORMALIZED=$(echo "$THEME_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
THEME_PATH="$THEMES_DIR/$THEME_NAME_NORMALIZED"

if [[ ! -d "$THEME_PATH" ]]; then
    echo "Theme '$THEME_NAME_NORMALIZED' does not exist in $THEMES_DIR" >&2
    exit 1
fi

echo "Applying GTK theme: $THEME_NAME"

# PHASE 1: Set up theme structure
ln -nsf "$THEME_PATH" "$CURRENT_THEME_DIR"

# Initialize variables
ACTUAL_THEME_NAME=$(basename "$THEME_PATH")
CAPITALIZED_THEME=$(echo "$ACTUAL_THEME_NAME" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-//g')
GTK_THEME_NAME="${CAPITALIZED_THEME}-Dark"

echo "Debug: ACTUAL_THEME_NAME=$ACTUAL_THEME_NAME"
echo "Debug: CAPITALIZED_THEME=$CAPITALIZED_THEME" 
echo "Debug: GTK_THEME_NAME=$GTK_THEME_NAME"

# Update .themes symlink
if [[ -d "$HOME/.themes" ]]; then
    SYMLINK_PATH=$(find "$HOME/.themes" -maxdepth 1 -type l | head -n 1)
    
    if [[ -n "$SYMLINK_PATH" ]]; then
        NEW_NAME="$HOME/.themes/${GTK_THEME_NAME}"
        
        mv "$SYMLINK_PATH" "$NEW_NAME"
        
        # Update cache
        echo "Updating GTK cache..."
        sleep 0.5
        gtk-update-icon-cache -f "$NEW_NAME" 2>/dev/null || true
    fi
fi

# PHASE 2: Wait for everything to settle
echo "Finalizing theme setup..."
sleep 1

# PHASE 3: Apply GTK settings
echo "Setting GTK theme: $GTK_THEME_NAME"

# Wait for D-Bus
for i in {1..10}; do
    if gsettings get org.gnome.desktop.interface gtk-theme &>/dev/null; then
        break
    fi
    sleep 0.3
done

# Apply GTK theme with safety
if [[ -d "$HOME/.themes/$GTK_THEME_NAME" ]]; then
    gsettings set org.gnome.desktop.interface gtk-theme "Default"
    sleep 0.3
    gsettings set org.gnome.desktop.interface gtk-theme "$GTK_THEME_NAME"
    gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
    
    # Set icon theme
    GNOME_ICONS_THEME="$HOME/.config/zorro/current/theme/icons.theme"
    if [[ -f "$GNOME_ICONS_THEME" ]]; then
        gsettings set org.gnome.desktop.interface icon-theme "$(cat "$GNOME_ICONS_THEME")"
    else
        gsettings set org.gnome.desktop.interface icon-theme "Yaru-blue"
    fi
    
    echo "âœ“ GTK theme applied: $GTK_THEME_NAME"
else
    echo "âš  Theme '$GTK_THEME_NAME' not found, using fallback"
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark"
    gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
fi

# PHASE 4: Restart GTK applications
echo "Restarting GTK applications..."
pkill thunar || true
sleep 0.5
thunar & disown

# Verify
CURRENT_THEME=$(gsettings get org.gnome.desktop.interface gtk-theme)
echo "âœ“ Current GTK theme: $CURRENT_THEME"
echo "ðŸŽ¨ GTK theme setup completed for: $THEME_NAME"
