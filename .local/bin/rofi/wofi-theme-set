#!/usr/bin/env bash

THEMES_DIR="$HOME/.config/zorro/themes/"
CURRENT_THEME_DIR="$HOME/.config/zorro/current/theme"

# Generate formatted theme list
THEME_NAME=$(find "$THEMES_DIR" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) | sort | \
  while read -r path; do
    echo "$(basename "$path" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')"
  done | wofi --dmenu --prompt "Select Theme" --lines 10)

[ -z "$THEME_NAME" ] && exit

# Normalize to directory name
THEME_NAME_NORMALIZED=$(echo "$THEME_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
THEME_PATH="$THEMES_DIR/$THEME_NAME_NORMALIZED"

if [[ ! -d "$THEME_PATH" ]]; then
  echo "Theme '$THEME_NAME_NORMALIZED' does not exist in $THEMES_DIR" >&2
  exit 2
fi

echo "Switching to theme: $THEME_NAME"

# Core theme setup only
ln -nsf "$THEME_PATH" "$CURRENT_THEME_DIR"

# Rename .themes symlink
if [[ -d "$HOME/.themes" ]]; then
    SYMLINK_PATH=$(find "$HOME/.themes" -maxdepth 1 -type l | head -n 1)
    
    if [[ -n "$SYMLINK_PATH" ]]; then
        ACTUAL_THEME_NAME=$(basename "$THEME_PATH")
        CAPITALIZED_THEME=$(echo "$ACTUAL_THEME_NAME" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-//g')
        NEW_NAME="$HOME/.themes/${CAPITALIZED_THEME}-Dark"
        mv "$SYMLINK_PATH" "$NEW_NAME"
    fi
fi

# Quick restarts (non-blocking)
z-theme-bg-next &
z-theme-bat &
tmux source-file ~/.config/tmux/tmux.conf &
z-restart waybar &
pkill -SIGUSR2 btop &

echo "Theme base setup completed: $THEME_NAME"
echo "Run 'zorro-theme-set-gtk' to apply GTK settings"
