#!/bin/bash

# Ask for URL (clipboard pre-filled)
URL=$(xclip -o -selection clipboard | dmenu -c -p "Enter URL (Ctrl+V to paste):")

# If nothing entered, quit
[ -z "$URL" ] && exit 1

# Try to get direct URL using yt-dlp
DIRECT_URL=$(yt-dlp -g "$URL" 2>/dev/null)

# If yt-dlp fails, fall back to original URL
[ -z "$DIRECT_URL" ] && DIRECT_URL="$URL"

# Extract filename from URL or from yt-dlp info
if [ -n "$DIRECT_URL" ]; then
    # Get filename from yt-dlp if possible
    FILENAME=$(yt-dlp --get-filename -o "%(title)s.%(ext)s" "$URL" 2>/dev/null)
    # Fallback to basename if yt-dlp fails
    [ -z "$FILENAME" ] && FILENAME=$(basename "${DIRECT_URL%%\?*}")
else
    FILENAME=$(basename "${URL%%\?*}")
fi

# Start aria2c in background, log output
aria2c --check-certificate=false -x 16 -s 16 -d "$HOME/Downloads" "$DIRECT_URL" \
  >> "$HOME/Downloads/aria2c.log" 2>&1 &

# Disown so it survives after dmenu exits
disown

# Notify about filename
notify-send "Download started" "$FILENAME"
