#!/usr/bin/env bash

# Options
options=(
  " Capture Desktop"
  "󰩭 Capture Area"
  " Capture Window"
  " Capture in 5s"
  "󱑈 Capture in 10s"
)

# Screenshot directory & filename
dir="$HOME/Pictures/screenshot"
mkdir -p "$dir"
timestamp=$(date +%Y-%m-%d-%H-%M-%S)
geometry=$(xrandr | grep 'current' | head -n1 | cut -d',' -f2 | tr -d '[:blank:],current')
file="$dir/Screenshot_${timestamp}_${geometry}.png"

# Notify and view
notify_view() {
  if [[ -f "$file" ]]; then
    dunstify -u low --replace=699 "Screenshot Saved and copied to clipboard."
    sxiv "$file"
  else
    dunstify -u low --replace=699 "Screenshot failed."
  fi
}

# Countdown
countdown() {
  for sec in $(seq "$1" -1 1); do
    dunstify -t 1000 --replace=699 "Taking shot in: $sec"
    sleep 1
  done
}

# Screenshot functions
shotnow() {
  flameshot full -p "$file" -c
  notify_view
}

shot5() {
  countdown 5
  flameshot full -p "$file" -c
  notify_view
}

shot10() {
  countdown 10
  flameshot full -p "$file" -c
  notify_view
}

shotwin() {
  # Flameshot doesn't have "active window" natively, simulate with selection over the window
  flameshot gui -p "$file" -c
  notify_view
}

shotarea() {
  flameshot gui -p "$file" -c
  notify_view
}

# Run chosen command
run_cmd() {
  case "$1" in
    "--opt1") shotnow ;;
    "--opt2") shotarea ;;
    "--opt3") shotwin ;;
    "--opt4") shot5 ;;
    "--opt5") shot10 ;;
  esac
}

# dmenu
chosen=$(printf '%s\n' "${options[@]}" | dmenu -l 7 -g 1 -i -p "Screenshot which area?")
case "$chosen" in
  "${options[0]}") run_cmd --opt1 ;;
  "${options[1]}") run_cmd --opt2 ;;
  "${options[2]}") run_cmd --opt3 ;;
  "${options[3]}") run_cmd --opt4 ;;
  "${options[4]}") run_cmd --opt5 ;;
esac
