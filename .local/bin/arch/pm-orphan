#!/bin/bash
# prunepkgs.sh â€” Safe Arch package pruning helper with logging & safeguard

set -euo pipefail

# Directories for logs
logdir="$HOME/.logs/pkg-prune"
mkdir -p "$logdir"

# Step 1: list orphaned packages
orphans=$(pacman -Qdtq)

echo "=== Orphaned packages ==="
if [ -z "$orphans" ]; then
    echo "No orphaned packages found ðŸŽ‰"
else
    echo "$orphans"
fi
echo

# Step 2: quick search for 'watched' packages (apps tied to configs)
watched=("grass" "waybar" "swww" "hyprland" "wofi" "gnome-weather")

echo "=== Watched packages installed ==="
for pkg in "${watched[@]}"; do
    if pacman -Qq | grep -qx "$pkg"; then
        echo "âš ï¸  $pkg is installed (linked to your configs)"
    fi
done
echo

# Step 3: interactive orphan removal
if [ -n "$orphans" ]; then
    # Filter out watched packages from orphans
    safe_orphans=()
    for o in $orphans; do
        if [[ " ${watched[*]} " =~ " ${o} " ]]; then
            echo "â­ï¸  Skipping $o (watched package)"
        else
            safe_orphans+=("$o")
        fi
    done

    if [ ${#safe_orphans[@]} -eq 0 ]; then
        echo "No safe orphaned packages to remove."
    else
        echo "Do you want to remove these orphaned packages? (y/N)"
        echo "${safe_orphans[@]}"
        read -r answer
        if [[ "$answer" =~ ^[Yy]$ ]]; then
            echo "$(date '+%Y-%m-%d %H:%M:%S') â€” Removing: ${safe_orphans[*]}" >> "$logdir/prune.log"
            sudo pacman -Rns "${safe_orphans[@]}"
            echo "$(date '+%Y-%m-%d %H:%M:%S') â€” Done removing above packages âœ…" >> "$logdir/prune.log"
        else
            echo "Skipping removal."
        fi
    fi
fi

echo "Done. System pruned safely ðŸŒ±"
