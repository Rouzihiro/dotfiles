#!/usr/bin/env bash

main_menu() {
    menu=(
				"ó°› Sys. Tools"
        "ó°…‡ Clipboard"
        "ï‘ Coding"
        "ó°’“ Theme"
        "ó°› Hardware"
        "ï’‡ Packages"
        "ó°ˆ™ Documents"
        "ó°‡§ Internet"
        "ó°Ž Multimedia"
        "ó°˜š Utilities"
				"ó°‹Š Mounting"
				"ïŒŠ Fedora" 
				"ïŒƒ Arch"
				"îš“Learn" 
 				"ï‡¬ Calculator"
				"ï‚¬ VPN"
        "ó°©› Exit"
    )

    # Show rofi menu
    selected=$(printf '%s\n' "${menu[@]}" | rofi -dmenu -i -p "Quick Actions" -theme ~/.config/rofi/quick-actions.rasi)

    # Handle selection (empty string means ESC was pressed)
    if [ -z "$selected" ]; then
        exit 0  # ESC from main menu exits completely
    elif [ -n "$selected" ]; then
        case "$selected" in
						"ó°› Sys. Tools")
								system_menu
								;;
            "ó°…‡ Clipboard")
                clipse-gui
                ;;
            "ï‘ Coding")
                coding_menu
                ;;
            "ó°’“ Theme")
                theme_menu
                ;;
            "ó°› Hardware")
                hardware_menu
                ;;
            "ï‚¬ VPN")
                ~/.config/waybar/scripts/tailscale.sh
                ;;
            "ï’‡ Packages")
                packages_menu                 
								;;
            "ï‡¬ Calculator")
                rofi -show calc -modi calc -no-show-match -no-sort
                ;;
            "ó°ˆ™ Documents")
                documents_menu
                ;;
            "ó°‡§ Internet")
                internet_menu
                ;;
            "ó°Ž Multimedia")
                multimedia_menu
                ;;
            "ó°˜š Utilities")
                utilities_menu
                ;;
						"ó°‹Š Mounting")
								mounting_menu
								;;
						"ïŒŠ Fedora")
						fedora_menu
								;;
						"ïŒƒ Arch")
						arch_menu
								;;
						"îš“Learn")
							learn_menu
								;;
            "ó°©› Exit")
                exit 0
                ;;
        esac
        
        # Loop back to main menu after action (unless user exited)
        if [ "$selected" != "ó°©› Exit" ]; then
            main_menu
        fi
    fi
}

# System Tools Menu (Option 3 with install capabilities)
system_menu() {
    tools_menu=(
        "ðŸ“Š Disk Usage (duf)"
        "ðŸ“ˆ System Monitor (btop)"
        "ðŸŒ Network Monitor (nethogs)"
        "ðŸ’¾ Disk Space (ncdu)"
        "ðŸ” File Search (fzf)"
        "ðŸ“ Tree View"
        "âš¡ Process Monitor (btm)"
        "â¬‡ï¸ Install Tools"
        "ó° Back"
    )
    
    tool_selected=$(printf '%s\n' "${tools_menu[@]}" | rofi -dmenu -i -p "System Tools" -theme ~/.config/rofi/quick-actions-small.rasi)
    
    if [ -z "$tool_selected" ]; then
        # Return to wherever we came from
        return
    fi
    
    case "$tool_selected" in
        *duf*)
            present_terminal "duf"
            ;;
        *btop*)
            present_terminal "btop"
            ;;
        *nethogs*)
            present_terminal "sudo nethogs"
            ;;
        *ncdu*)
            present_terminal "ncdu"
            ;;
        *fzf*)
            present_terminal "fzf"
            ;;
        *Tree*View*)
            present_terminal "tree"
            ;;
        *btm*)
            present_terminal "btm"
            ;;
        *Install*Tools*)
            install_tools_menu
            ;;
        "ó° Back")
            return
            ;;
    esac
    
    system_tools_menu
}

detect_distro() {
    if [ -f /etc/arch-release ]; then
        echo "arch"
    elif [ -f /etc/fedora-release ]; then
        echo "fedora"
    else
        echo "unknown"
    fi
}

install_tool() {
    local tool_name=$1
    local distro=$(detect_distro)
    
    case "$distro" in
        arch)
            present_terminal "echo 'Installing $tool_name on Arch...'; sudo pacman -S --noconfirm $tool_name"
            ;;
        fedora)
            present_terminal "echo 'Installing $tool_name on Fedora...'; sudo dnf install -y $tool_name"
            ;;
        *)
            present_terminal "echo 'Unknown distribution: $distro'; sleep 5"
            ;;
    esac
}

install_tools_menu() {
    local distro=$(detect_distro)
    
    install_menu=(
        "ðŸ“Š Install duf"
        "ðŸ“ˆ Install btop"
				"ðŸ“ˆ Install htop"
        "ðŸŒ Install nethogs"
        "ðŸ’¾ Install ncdu"
        "ðŸ” Install fzf"
        "ðŸ“ Install tree"
        "âš¡ Install bottom (btm)"
        "ó° Back to System Tools"
    )
    
    install_selected=$(printf '%s\n' "${install_menu[@]}" | rofi -dmenu -i -p "Install Tools ($distro)" -theme ~/.config/rofi/quick-actions-small.rasi)
    
    if [ -z "$install_selected" ]; then
        system_tools_menu
        return
    fi
    
    case "$install_selected" in
        *duf*)
            install_tool "duf"
            ;;
        *htop*)
            install_tool "htop"
            ;;
				*btop*)
            install_tool "btop"
            ;;
        *nethogs*)
            install_tool "nethogs"
            ;;
        *ncdu*)
            install_tool "ncdu"
            ;;
        *fzf*)
            install_tool "fzf"
            ;;
        *tree*)
            install_tool "tree"
            ;;
        *bottom*)
            install_tool "bottom"
            ;;
        "ó° Back to System Tools")
            system_tools_menu
            return
            ;;
    esac
    
    install_tools_menu
}


packages_menu() {
    packages_menu=(
	"ï’‡ Zorro Package Installer"
	"ï’‡ Package Installer"
        "ó° Back to Main"
    )
    
    packages_selected=$(printf '%s\n' "${packages_menu[@]}" | rofi -dmenu -i -p "Packages" -theme ~/.config/rofi/quick-actions.rasi)
    if [ -z "$packages_selected" ]; then
        main_menu
        return
    fi
    
    case "$packages_selected" in
			"ï’‡ Zorro Package Installer")
				foot -e bash -c "z-pkg-install; exec bash"
            ;;
			"ï’‡ Package Installer")
	 		"z-pkg-install-lite"
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    packages_menu
}

coding_menu() {
    coding_menu=(
			"ï‘ Shell Scripts (PATH)"
			"ï‘ Zorro File Manager"
			"ï‘ Zorro Scripts"
			"ï‘ Dotfiles Scripts"
        "ó° Back to Main"
    )
    
    coding_selected=$(printf '%s\n' "${coding_menu[@]}" | rofi -dmenu -i -p "Coding" -theme ~/.config/rofi/quick-actions.rasi)
    if [ -z "$coding_selected" ]; then
        main_menu
        return
    fi
    
    case "$coding_selected" in
			"ï‘ Shell Scripts (PATH)")
				rofi-scripts
            ;;
			"ï‘ Zorro File Manager")
			foot -e bash -c "superb; exec bash"
            ;;
			"ï‘ Dotfiles Scripts")
			foot -e bash -c "dotfiles-scripts; exec bash"
            ;;
			"ï‘ Zorro Scripts")
			foot -e bash -c "zorro-scripts; exec bash"
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    coding_menu
}

theme_menu() {
    # Theme submenu
    theme_menu=(
        "ï€¾ Wallpaper"
        "ó°ž… Emojis"
        "î¾¨ Icons"
        "ó°° GTK-Theme-Installer"
        "ðŸŽ¨ Theme Switcher"
				"ðŸŽ¨ Update Starship"
				"ðŸŽ¨ Generate palettes"
				"ðŸŽ¨ Cache update"
				"ó±§¿ Refresh Themes"
        "ó° Back to Main"
    )
    
    theme_selected=$(printf '%s\n' "${theme_menu[@]}" | rofi -dmenu -i -p "Theme" -theme ~/.config/rofi/quick-actions.rasi)
    
    # Handle ESC key (empty selection)
    if [ -z "$theme_selected" ]; then
        main_menu
        return
    fi
    
    case "$theme_selected" in
        "ï€¾ Wallpaper")
            rofi-wall
            ;;
        "ó°ž… Emojis")
            rofi-emoji
            ;;
        "î¾¨ Icons")
            ~/.config/waybar/scripts/icon-picker.sh
            ;;
        "ó°° GTK-Theme-Installer")
            z-theme-set-gtk
            ;;
        "ðŸŽ¨ Theme Switcher")
            rofi-theme-set
            ;;
			 "ðŸŽ¨ Update Starship palettes")
						present_terminal "python /home/rey/Projects/theme-generator/starship_generator.py"
            ;;
			 "ðŸŽ¨ Generate palettes")
            present_terminal "z-theme-palettes-gen"
            ;;
				"ðŸŽ¨ Cache update")
						present_terminal "z-theme-cache"
						;;
				"*Refresh Themes*")
						present_terminal "$HOME/dotfiles/install-themes.sh"
						;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    
    # Loop back to theme menu unless going back to main
    theme_menu
}

hardware_menu() {
    # Hardware submenu
    hardware_menu=(
        "ó°¹ Power"
        "ïŠ“ Bluetooth"
        "ó°–© WiFi"
        "ó°‚° Power Profile"
        "ó°•¾ Sound"
        "ó° Back to Main"
    )
    
    hardware_selected=$(printf '%s\n' "${hardware_menu[@]}" | rofi -dmenu -i -p "Hardware" -theme ~/.config/rofi/quick-actions.rasi)
    
    # Handle ESC key (empty selection)
    if [ -z "$hardware_selected" ]; then
        main_menu
        return
    fi
    
    case "$hardware_selected" in
        "ó°¹ Power")
            rofi-power
            ;;
        "ïŠ“ Bluetooth")
            rofi-bluetooth
            ;;
        "ó°–© WiFi")
            rofi-wifi
            ;;
        "ó°‚° Power Profile")
            rofi-power-profile
            ;;
        "ó°•¾ Sound")
            ~/.config/waybar/scripts/rofi-audio.sh
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    
    # Loop back to hardware menu unless going back to main
    hardware_menu
}

documents_menu() {
    # Documents submenu
    docs_menu=(
        "ðŸ“„ Documents"
        "ðŸ“ Notes"
        "ðŸ“š Books"
        "ó° Back to Main"
    )
    
    docs_selected=$(printf '%s\n' "${docs_menu[@]}" | rofi -dmenu -i -p "Documents" -theme ~/.config/rofi/quick-actions.rasi)
    
    # Handle ESC key (empty selection)
    if [ -z "$docs_selected" ]; then
        main_menu
        return
    fi
    
    case "$docs_selected" in
        "ðŸ“„ Documents")
            rofi-docs
            ;;
        "ðŸ“ Notes")
            rofi-notes
            ;;
        "ðŸ“š Books")
            rofi-docs
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    
    # Loop back to documents menu unless going back to main
    documents_menu
}

internet_menu() {
    # Internet submenu
    internet_menu=(
        "ðŸ”— Bookmarks"
        "ðŸ“¥ Downloader"
        "ó° Back to Main"
    )
    
    internet_selected=$(printf '%s\n' "${internet_menu[@]}" | rofi -dmenu -i -p "Internet" -theme ~/.config/rofi/quick-actions.rasi)
    
    # Handle ESC key (empty selection)
    if [ -z "$internet_selected" ]; then
        main_menu
        return
    fi
    
    case "$internet_selected" in
        "ðŸ”— Bookmarks")
            rofi-bookmarks
            ;;
        "ðŸ“¥ Downloader")
            rofi-aria
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    
    # Loop back to internet menu unless going back to main
    internet_menu
}

multimedia_menu() {
    # Multimedia submenu
    media_menu=(
        "ðŸŽ¬ Video Tools"
        "ðŸŽ¥ Video Player"
        "ðŸ“¹ Screenrecord"
				"ðŸ–¼ï¸ Screenshot"
				"ðŸ–¼ï¸ Screenshot (FS)"
				"ðŸ–¼ï¸ OCR"
				"ðŸ–¼ï¸ Textpicker"
        "ó° Back to Main"
    )	
    
    media_selected=$(printf '%s\n' "${media_menu[@]}" | rofi -dmenu -i -p "Multimedia" -theme ~/.config/rofi/quick-actions.rasi)
    
    # Handle ESC key (empty selection)
    if [ -z "$media_selected" ]; then
        main_menu
        return
    fi
    
    case "$media_selected" in
        "ðŸŽ¬ Video Tools")
            rofi-video-tool
            ;;
        "ðŸŽ¥ Video Player")
            rofi-video-list
            ;;
        "ðŸ“¹ Screenrecord")
            screenrecord_menu
            ;;
				"ðŸ–¼ï¸ Screenshot")
            rofi-screenshot
            ;;
				"ðŸ–¼ï¸ Screenshot (FS)")
            rofi-screenshot-fs
            ;;
				"ðŸ–¼ï¸ OCR")
						ocr
						;;
				"ðŸ–¼ï¸ Textpicker")
						text-picker
						;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    
    # Loop back to multimedia menu unless going back to main
    multimedia_menu
}
screenrecord_menu() {
    screenrecord_options=(
        "ï€½ No audio"
        "ï€½ System audio" 
        "ï€½ Microphone"
        "ï€½ Mic + Camera"
        "â¹ï¸ Stop"
        "ó° Back to Multimedia"
    )

    screenrecord_selected=$(printf '%s\n' "${screenrecord_options[@]}" | rofi -dmenu -i -p "Screen Record" -theme ~/.config/rofi/quick-actions.rasi)
    
    if [ -z "$screenrecord_selected" ]; then
        multimedia_menu
        return
    fi
    
    case "$screenrecord_selected" in
        *"No audio")
            z-cmd-screenrecord --no-audio
            notify-send "Screen Record" "Starting recording with no audio"
            ;;
        *"System audio")
            z-cmd-screenrecord --with-desktop-audio
            notify-send "Screen Record" "Starting recording with desktop audio"
            ;;
        *"Microphone")
            z-cmd-screenrecord --with-desktop-audio --with-microphone-audio
            notify-send "Screen Record" "Starting recording with desktop + microphone audio"
            ;;
        *"Mic + Camera")
            z-cmd-screenrecord --with-desktop-audio --with-microphone-audio --with-webcam
            notify-send "Screen Record" "Starting recording with desktop + microphone audio + webcam"
            ;;
        *"Stop")
            z-cmd-screenrecord --stop-recording
            notify-send "Screen Record" "Stopping recording"
            ;;
        *"Back to Multimedia")
            multimedia_menu
            return
            ;;
    esac
    
    screenrecord_menu
}

utilities_menu() {
    # Utilities submenu
    utils_menu=(
        "ðŸ“‹ Clipboard"
        "ðŸ–¼ï¸ Screenshot"
 				"ðŸ–¼ï¸ Screenshot (FS)"
        "ðŸ“œ Scripts"
        "ó° Back to Main"
    )
    
    utils_selected=$(printf '%s\n' "${utils_menu[@]}" | rofi -dmenu -i -p "Utilities" -theme ~/.config/rofi/quick-actions.rasi)
    
    # Handle ESC key (empty selection)
    if [ -z "$utils_selected" ]; then
        main_menu
        return
    fi
    
    case "$utils_selected" in
        "ðŸ“‹ Clipboard")
            rofi-clipboard
            ;;
        "ðŸ–¼ï¸ Screenshot")
            rofi-screenshot
            ;;
					"ðŸ–¼ï¸ Screenshot (FS)")
 					rofi-screenshot-fs
            ;;
        "ðŸ“œ Scripts")
            rofi-scripts
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    
    # Loop back to utilities menu unless going back to main
    utilities_menu
}

arch_menu() {
    arch_menu=(
        "ïŒƒ Pacman Cleaner"
        "ïŒƒ AUR Cleaner"
				"ïŒƒ Orphan Remover"
        "ïŒƒ List Packages"
        "ïŒƒ Swap Setup"
        "ó° Back to Main"
    )

    arch_selected=$(printf '%s\n' "${arch_menu[@]}" | rofi -dmenu -i -p "Arch Linux" -theme ~/.config/rofi/quick-actions.rasi)
    if [ -z "$arch_selected" ]; then
        main_menu
        return
    fi

    case "$arch_selected" in
        "ïŒƒ Pacman Cleaner")
            pacman-cleaner.sh
            ;;
				 "*Orphan*")
            pm-orphan
            ;;
        "ïŒƒ AUR Cleaner")
            aur-cleaner.sh
            ;;
        "ïŒƒ List Packages")
            list-pkgs
            ;;
        "ïŒƒ Swap Setup")
            swap-setup-arch
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    arch_menu
}

fedora_menu() {
    fedora_menu=(
        "ïŒŠ Swap Setup"
        "ó° Back to Main"
    )

    fedora_selected=$(printf '%s\n' "${fedora_menu[@]}" | rofi -dmenu -i -p "Fedora" -theme ~/.config/rofi/quick-actions.rasi)
    if [ -z "$fedora_selected" ]; then
        main_menu
        return
    fi

    case "$fedora_selected" in
        "ïŒŠ Swap Setup")
            swap-setup-fedora
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    fedora_menu
}

mounting_menu() {
    mounting_menu=(
        "ó°‹Š Mount USB"
        "ó°›³ Mount NAS"
        "ó°‡š Mount ISO"
        "ó° Back to Main"
    )

    mounting_selected=$(printf '%s\n' "${mounting_menu[@]}" | rofi -dmenu -i -p "Mounting" -theme ~/.config/rofi/quick-actions.rasi)
    if [ -z "$mounting_selected" ]; then
        main_menu
        return
    fi

    case "$mounting_selected" in
        "ó°‹Š Mount USB")
            rofi-mount-usb
            ;;
        "ó°›³ Mount NAS")
						rofi-mount-nas
            ;;
        "ó°‡š Mount ISO")
            rofi-mount-iso
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    mounting_menu
}

learn_menu() {
    learn_menu=(
        "ï„œ Keybindings"
        "îª„ Github"
        "ï™ Hyprland"
        "ó°£‡ Arch"
        "îš® Neovim"
        "ó±†ƒ Bash"
        "ó° Back to Main"
    )
    
    learn_selected=$(printf '%s\n' "${learn_menu[@]}" | rofi -dmenu -i -p "Learn" -theme ~/.config/rofi/quick-actions.rasi)
    
    if [ -z "$learn_selected" ]; then
        main_menu
        return
    fi
    
    case "$learn_selected" in
        *Keybindings*) 
					Keybinds_learn_menu
            ;;
        *Github*)
            xdg-open "https://github.com/Rouzihiro" 2>/dev/null &
            ;;
        *Hyprland*)
            xdg-open "https://wiki.hypr.land/" 2>/dev/null &
            ;;
        *Arch*)
            xdg-open "https://wiki.archlinux.org/title/Main_page" 2>/dev/null &
            ;;
        *Bash*)
            xdg-open "https://devhints.io/bash" 2>/dev/null &
            ;;
        *Neovim*)
            xdg-open "https://www.lazyvim.org/keymaps" 2>/dev/null &
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    
    # Loop back to learn menu unless going back to main
    learn_menu
}

Keybinds_learn_menu() {
    # Keybinds submenu
    kb_menu=(
        "ï„œ Sway Keybinds"
        "ï„œ Sway Keybinds 2"
        "ï„œ Hyprland Keybinds"
        "ï„œ ZSH Keybinds"
				"ï„œ Cheats"
        "ó° Back to Main"
    )
    
    kb_selected=$(printf '%s\n' "${kb_menu[@]}" | rofi -dmenu -i -p "Keybinds" -theme ~/.config/rofi/quick-actions.rasi)
    
    # Handle ESC key (empty selection)
    if [ -z "$kb_selected" ]; then
        main_menu
        return
    fi
    
    case "$kb_selected" in
        "ï„œ Sway Keybinds")
            cheatsheet-sway
            ;;
        "ï„œ Sway Keybinds 2")
            "$HOME/.local/bin/zorro/z-menu-keybindings-sway-soft"
            ;;
        "ï„œ Hyprland Keybinds")
						cheatsheet-hypr
            ;;
        "ï„œ ZSH Keybinds")
            notify-send "Keybinds" "ZSH keybinds not configured yet"
            ;;
  			"ï„œ Cheats")
					foot -e bash -c "cheats; exec bash"
            ;;
        "ó° Back to Main")
            main_menu
            return
            ;;
    esac
    
    Keybinds_learn_menu
}

present_terminal() {
    if command -v z-launch-floating-terminal >/dev/null 2>&1; then
        z-launch-floating-terminal "$1"
    else
        foot -e bash -c "$1; exec bash"
    fi
}


# Start the main menu
main_menu
