#!/bin/bash

# Script to extract specific colors from rofi.rasi and prepend to tmux-colors

input_file="rofi.rasi"
template_file="tmux-template.conf"
output_file="tmux-colors"

# Check if input files exist
if [ ! -f "$input_file" ]; then
    echo "Error: $input_file not found in current directory"
    exit 1
fi

if [ ! -f "$template_file" ]; then
    echo "Error: $template_file not found in current directory"
    exit 1
fi

# Step 1: Copy tmux-template.conf to tmux-colors
cp "$template_file" "$output_file"

# Step 2: Create a temporary file for the converted colors
temp_file=$(mktemp)

# First pass: collect all color definitions including @colorX references
declare -A color_map

while IFS= read -r line; do
    if [[ "$line" =~ ([a-zA-Z0-9-]+):[[:space:]]*([^;]+) ]]; then
        var_name="${BASH_REMATCH[1]}"
        var_value="${BASH_REMATCH[2]}"
        var_name=$(echo "$var_name" | tr -d '[:space:]')
        var_value=$(echo "$var_value" | tr -d '[:space:]')
        
        # Store all color variables for reference resolution
        color_map["$var_name"]="$var_value"
    fi
done < "$input_file"

# Function to resolve color references (handle @colorX)
resolve_color() {
    local value="$1"
    if [[ "$value" =~ ^@([a-zA-Z0-9-]+)$ ]]; then
        local ref_name="${BASH_REMATCH[1]}"
        if [[ -n "${color_map[$ref_name]}" ]]; then
            echo "${color_map[$ref_name]}"
        else
            echo "$value"
        fi
    else
        echo "$value"
    fi
}

# Function to remove alpha channel from colors (for tmux compatibility)
remove_alpha() {
    local color="$1"
    # If color has 8 characters (including alpha), remove last 2
    if [[ ${#color} -eq 9 ]]; then  # including the # symbol
        echo "${color:0:7}"
    else
        echo "$color"
    fi
}

# Extract base colors
echo "base=\"$(remove_alpha "$(resolve_color "${color_map[background]}")")\"" >> "$temp_file"
echo "text=\"$(remove_alpha "$(resolve_color "${color_map[foreground]}")")\"" >> "$temp_file"
echo "crust=\"$(remove_alpha "$(resolve_color "${color_map[color8]}")")\"" >> "$temp_file"

# Extract signature colors
echo "sig1=\"$(remove_alpha "$(resolve_color "${color_map[sig1]}")")\"" >> "$temp_file"
echo "sig2=\"$(remove_alpha "$(resolve_color "${color_map[sig2]}")")\"" >> "$temp_file"
echo "on_sig1=\"$(remove_alpha "$(resolve_color "${color_map[on-sig1]}")")\"" >> "$temp_file"
echo "on_sig2=\"$(remove_alpha "$(resolve_color "${color_map[on-sig2]}")")\"" >> "$temp_file"
echo "on_sigbg=\"$(remove_alpha "$(resolve_color "${color_map[on-sigbg]}")")\"" >> "$temp_file"
echo "sig_bg=\"$(remove_alpha "$(resolve_color "${color_map[sigbg]}")")\"" >> "$temp_file"
echo "sig_surface_high=\"$(remove_alpha "$(resolve_color "${color_map[sig-surface-high]}")")\"" >> "$temp_file"

echo "" >> "$temp_file"
echo "# Color palette (from Rofi colors)" >> "$temp_file"

# Extract main color palette
echo "red=\"$(remove_alpha "$(resolve_color "${color_map[color1]}")")\"" >> "$temp_file"
echo "green=\"$(remove_alpha "$(resolve_color "${color_map[color2]}")")\"" >> "$temp_file"
echo "yellow=\"$(remove_alpha "$(resolve_color "${color_map[color3]}")")\"" >> "$temp_file"
echo "blue=\"$(remove_alpha "$(resolve_color "${color_map[color4]}")")\"" >> "$temp_file"
echo "magenta=\"$(remove_alpha "$(resolve_color "${color_map[color5]}")")\"" >> "$temp_file"
echo "cyan=\"$(remove_alpha "$(resolve_color "${color_map[color6]}")")\"" >> "$temp_file"
echo "white=\"$(remove_alpha "$(resolve_color "${color_map[color7]}")")\"" >> "$temp_file"
echo "black=\"$(remove_alpha "$(resolve_color "${color_map[color0]}")")\"" >> "$temp_file"

echo "" >> "$temp_file"
echo "# Bright colors" >> "$temp_file"

# Extract bright colors
echo "bright_black=\"$(remove_alpha "$(resolve_color "${color_map[color8]}")")\"" >> "$temp_file"
echo "bright_red=\"$(remove_alpha "$(resolve_color "${color_map[color9]}")")\"" >> "$temp_file"
echo "bright_green=\"$(remove_alpha "$(resolve_color "${color_map[color10]}")")\"" >> "$temp_file"
echo "bright_yellow=\"$(remove_alpha "$(resolve_color "${color_map[color11]}")")\"" >> "$temp_file"
echo "bright_blue=\"$(remove_alpha "$(resolve_color "${color_map[color12]}")")\"" >> "$temp_file"
echo "bright_magenta=\"$(remove_alpha "$(resolve_color "${color_map[color13]}")")\"" >> "$temp_file"
echo "bright_cyan=\"$(remove_alpha "$(resolve_color "${color_map[color14]}")")\"" >> "$temp_file"
echo "bright_white=\"$(remove_alpha "$(resolve_color "${color_map[color15]}")")\"" >> "$temp_file"

# Step 3: Prepend the converted colors to the tmux-colors file
cat "$temp_file" "$output_file" > "${output_file}.new" && mv "${output_file}.new" "$output_file"

# Clean up
rm "$temp_file"

echo "Conversion complete!"
echo "Extracted all required colors from $input_file and prepended to $output_file"
echo "Note: Alpha channels removed from colors for tmux compatibility"
