#!/bin/bash

# Get the theme directory path
THEME_PATH=$(readlink -f "$HOME/.config/zorro/current/theme")

# Read GTK theme name from file
GTK_THEME_FILE="$THEME_PATH/gtk-theme"
if [[ -f "$GTK_THEME_FILE" ]]; then
    GTK_THEME_NAME=$(cat "$GTK_THEME_FILE" | tr -d '\n')
    echo "Found GTK theme name in file: $GTK_THEME_NAME"
else
    echo "Error: gtk-theme file not found at $GTK_THEME_FILE" >&2
    exit 1
fi

echo "Setting up GTK theme: $GTK_THEME_NAME"

# Rename the symlink in ~/.themes to match the theme name
THEMES_DIR="$HOME/.themes"
if [[ -d "$THEMES_DIR" ]]; then
    # Find the single symlink in ~/.themes
    OLD_SYMLINK=$(find "$THEMES_DIR" -maxdepth 1 -type l | head -1)
    if [[ -n "$OLD_SYMLINK" ]]; then
        OLD_NAME=$(basename "$OLD_SYMLINK")
        NEW_SYMLINK="$THEMES_DIR/$GTK_THEME_NAME"
        
        if [[ "$OLD_NAME" != "$GTK_THEME_NAME" ]]; then
            echo "Renaming theme symlink: $OLD_NAME -> $GTK_THEME_NAME"
            mv "$OLD_SYMLINK" "$NEW_SYMLINK"
        fi
    else
        echo "Warning: No symlink found in $THEMES_DIR" >&2
    fi
fi

# Wait for D-Bus but don't block too long
for i in {1..10}; do
    gsettings get org.gnome.desktop.interface gtk-theme &>/dev/null && break
    sleep 0.5
done

# Safety: Verify theme exists
if [[ ! -d "$HOME/.themes/$GTK_THEME_NAME" ]]; then
    echo "Warning: GTK theme '$GTK_THEME_NAME' not found, using fallback" >&2
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark"
    gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
    gsettings set org.gnome.desktop.interface icon-theme "Yaru-blue"
    exit 0
fi

# Update cache
gtk-update-icon-cache -f "$HOME/.themes/$GTK_THEME_NAME" 2>/dev/null || true

# Execute theme script if exists (with timeout safety)
if [[ -f "$HOME/.config/zorro/current/theme/gtk.sh" ]]; then
    echo "Running theme GTK script"
    timeout 10s bash "$HOME/.config/zorro/current/theme/gtk.sh" 2>/dev/null || \
        echo "Theme script timed out or failed" >&2
else
    # Direct theme application
    gsettings set org.gnome.desktop.interface gtk-theme "$GTK_THEME_NAME"
    gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark'
    
    # Icon theme fallback
    GNOME_ICONS_THEME="$HOME/.config/zorro/current/theme/icons.theme"
    if [[ -f "$GNOME_ICONS_THEME" ]]; then
        gsettings set org.gnome.desktop.interface icon-theme "$(cat "$GNOME_ICONS_THEME")"
    else
        gsettings set org.gnome.desktop.interface icon-theme "Yaru-blue"
    fi
fi

echo "GTK theme applied: $GTK_THEME_NAME"
