#!/bin/bash

THEMES_DIR="$HOME/dotfiles/themes"
PREVIEW_NAME="color-palette.png"
PALETTES_DIR="$HOME/assets/color-palettes"

# Function to parse kitty.conf and extract colors
parse_kitty_conf() {
    local conf_file="$1"
    local -A colors
    
    while IFS= read -r line; do
        # Skip comments and empty lines
        [[ $line =~ ^[[:space:]]*# ]] && continue
        [[ -z "${line//[[:space:]]/}" ]] && continue
        
        # Match color definitions (simplified regex)
        if [[ $line =~ ^[[:space:]]*([a-z0-9_]+)[[:space:]]+(#[a-fA-F0-9]{6}) ]]; then
            color_name="${BASH_REMATCH[1]}"
            color_value="${BASH_REMATCH[2]}"
            colors["$color_name"]="$color_value"
        fi
    done < "$conf_file"
    
    # Return the colors array
    declare -p colors
}

# Function to generate color palette preview
generate_palette_preview() {
    local theme_dir="$1"
    local conf_file="$theme_dir/kitty.conf"
    local output="$theme_dir/$PREVIEW_NAME"
    
    if [[ ! -f "$conf_file" ]]; then
        echo "No kitty.conf found in $theme_dir, skipping..."
        return 1
    fi
    
    echo "Generating palette for $(basename "$theme_dir")..."
    
    # Parse the kitty.conf file
    eval "$(parse_kitty_conf "$conf_file")"
    
    # Get background and foreground
    local bg="${colors[background]:-#000000}"
    local fg="${colors[foreground]:-#FFFFFF}"
    
    # Choose which 12 colors to display
    # Option 1: color0-color11 (first 12 colors)
    # Option 2: Mix of normal and bright colors
    # Option 3: Custom selection - let's do color0-color7 + color8-color11
   
# Mix: color0-color5 + color8-color13 (balanced)
local display_colors=()
# 6 normal colors
for i in {0..5}; do
    local color_key="color$i"
    display_colors+=("${colors[$color_key]:-#000000}")
done
# 6 bright colors  
for i in {8..13}; do
    local color_key="color$i"
    display_colors+=("${colors[$color_key]:-#000000}")
done


    local display_colors=()
    
    # Add color0-color7 (normal colors)
    for i in {0..7}; do
        local color_key="color$i"
        if [[ -n "${colors[$color_key]}" ]]; then
            display_colors+=("${colors[$color_key]}")
        else
            # Use black as placeholder for missing colors
            display_colors+=("#000000")
        fi
    done
    
    # Add color8-color11 (first 4 bright colors)
    for i in {8..11}; do
        local color_key="color$i"
        if [[ -n "${colors[$color_key]}" ]]; then
            display_colors+=("${colors[$color_key]}")
        else
            display_colors+=("#000000")
        fi
    done
    
    # If we want exactly 12 colors but different ones, here are other options:
    # Option A: All bright colors (color8-color15) + 4 normal colors
    # Option B: Every other color from the 16
    # Option C: Custom curated selection
    
    # Generate the preview image
    if command -v magick &> /dev/null || command -v convert &> /dev/null; then
        local draw_cmd=()
        
        # Theme name
        local theme_name=$(basename "$theme_dir" | sed -E 's/(^|-)([a-z])/\1\u\2/g; s/-/ /g')
				draw_cmd+=("-fill" "$fg" "-font" "DejaVu-Sans" "-pointsize" "14" "-annotate" "+20+25" "$theme_name")
        
        # Draw the 12 color blocks in a 4x3 grid (4 columns, 3 rows)
        local start_x=20
        local start_y=45
        local block_size=25
        local spacing=5
        local blocks_per_row=4  # 4 columns
        local total_blocks=12
        
        for i in $(seq 0 $((total_blocks-1))); do
            local row=$((i / blocks_per_row))
            local col=$((i % blocks_per_row))
            local x=$((start_x + col * (block_size + spacing)))
            local y=$((start_y + row * (block_size + spacing)))
            local x2=$((x + block_size))
            local y2=$((y + block_size))
            
            draw_cmd+=("-fill" "${display_colors[i]}" "-draw" "rectangle $x,$y $x2,$y2")
        done
        
        # Use magick or convert
        if command -v magick &> /dev/null; then
            magick -size 180x150 xc:"$bg" "${draw_cmd[@]}" "$output"
        else
            convert -size 180x150 xc:"$bg" "${draw_cmd[@]}" "$output"
        fi
    fi
    
    echo "Created: $output"
}

# Function to copy palettes to assets directory (with exact folder names)
copy_palettes_to_assets() {
    echo "Copying palette images to $PALETTES_DIR..."
    mkdir -p "$PALETTES_DIR"
    
    local count=0
    find "$THEMES_DIR" -name "$PREVIEW_NAME" | while read -r palette; do
        local theme_dir=$(dirname "$palette")
        local theme_name=$(basename "$theme_dir")  # Keep exact folder name
        local dest_file="$PALETTES_DIR/${theme_name}.png"  # Use exact folder name
        
        # Overwrite if exists
        cp -f "$palette" "$dest_file"
        echo "  âœ“ $theme_name"
        ((count++))
    done
    
    echo "Copied $count palette images to $PALETTES_DIR"
}

# Main function to process all themes
main() {
    echo "Generating color palette previews for all themes in $THEMES_DIR..."
    echo "Found themes:"
    
    find "$THEMES_DIR" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) | sort | while read -r theme_dir; do
        local theme_name=$(basename "$theme_dir")
        echo "  - $theme_name"
        
        # Generate the preview (will overwrite existing)
        generate_palette_preview "$theme_dir"
    done
    
    echo ""
    echo "Color palette generation complete!"
    echo "Preview images saved as '$PREVIEW_NAME' in each theme directory"
    
    # Ask user if they want to copy to assets directory
    echo ""
    read -p "Do you want to store a copy of each palette inside $PALETTES_DIR? (y/N): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        copy_palettes_to_assets
    else
        echo "Skipping copy to assets directory."
    fi
}

# Run the main function
main
