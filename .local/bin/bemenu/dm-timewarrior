#!/bin/bash

# Main categories
CATEGORIES=(
    "PROGRAMMING"
    "OSTEOLOGY"
    "TRAUMA-GERIATRIC(BG)"
    "TRAUMA-GERIATRIC(UKE)"
    "VIDEO/SERIES"
    "YOUTUBE"
    "BROWSING"
    "WASTED"
    "STOP"
    "⚙ Timewarrior Menu"   # extra menu entry
)

# Select main category
selected=$(printf "%s\n" "${CATEGORIES[@]}" | dmenu -i -l 12 -p "Select category:")
status=$?

if [[ $status -ne 0 || -z "$selected" ]]; then
    exit 0
fi

tmux set -g status-interval 5

# Handle Timewarrior submenu separately
if [[ "$selected" == "⚙ Timewarrior Menu" ]]; then
    OPTIONS=("▶ Start tracking" \
             "⏹ Stop tracking" \
             "⏸ Continue last" \
             "📊 Today's summary" \
             "📈 Weekly report" \
             "📤 Export today to Notes" \
             "🏷 Add tag" \
             "📝 Add annotation" \
             "🗑 Delete last entry" \
             "🔄 Sync" \
             "🚪 Exit")

    CHOICE=$(printf "%s\n" "${OPTIONS[@]}" | dmenu -i -l 12 -p "⏰ Timewarrior:")

    case "$CHOICE" in
        "▶ Start tracking")
            PROJECT=$(echo "" | dmenu -p "Project name:")
            TAGS=$(echo "" | dmenu -p "Tags (+tag1 +tag2):")
            timew start "$PROJECT" $TAGS
            notify-send "Timewarrior" "Started: $PROJECT $TAGS"
            ;;
        "⏹ Stop tracking")
            timew stop
            notify-send "Timewarrior" "Tracking stopped"
            ;;
        "⏸ Continue last")
            timew continue
            notify-send "Timewarrior" "Continued last task"
            ;;
        "📊 Today's summary")
            SUMMARY=$(timew summary today)
            echo "$SUMMARY" | dmenu -l 20 -p "Today's time:"
            ;;
        "📈 Weekly report")
            SUMMARY=$(timew summary :week)
            echo "$SUMMARY" | dmenu -l 20 -p "This week:"
            ;;
        "📤 Export today to Notes")
            mkdir -p "$HOME/Documents/Notes/"
            FILENAME="$HOME/Documents/Notes/time-tracking-$(date +%Y-%m-%d).md"
            {
                echo "# Time Tracking - $(date +%Y-%m-%d)"
                echo ""
                echo "## Summary"
                echo '```'
                timew summary today
                echo '```'
                echo ""
                echo "## Detailed Export"
                echo '```'
                timew export today
                echo '```'
            } > "$FILENAME"
            notify-send "Timewarrior" "Exported to: $FILENAME"
            ;;
        "🏷 Add tag")
            TAG=$(echo "" | dmenu -p "Add tag (+tag):")
            timew tag @1 "$TAG"
            notify-send "Timewarrior" "Added tag: $TAG"
            ;;
        "📝 Add annotation")
            NOTE=$(echo "" | dmenu -p "Add note:")
            timew annotate @1 "$NOTE"
            notify-send "Timewarrior" "Added note"
            ;;
        "🗑 Delete last entry")
            timew delete @1
            notify-send "Timewarrior" "Deleted last entry"
            ;;
        "🔄 Sync")
            notify-send "Timewarrior" "Sync complete"
            ;;
        "🚪 Exit")
            exit 0
            ;;
    esac
else
    # Handle normal categories tracking
    if [[ "$selected" == "STOP" ]]; then
        timew stop
        tmux set -g status-right "\
#[fg=#719cd6,bg=default]\
#[fg=#192330,bg=#719cd6]  #(echo \"#{pane_current_path}\" | awk -F/ '{ if (NF<=2) print \$NF; else print \$(NF-1)\"/\"\$NF; }') \
#[fg=#719cd6,bg=#9d79d6]#[fg=#192330,bg=#9d79d6]  \
#[fg=#9d79d6,bg=default]"
    else
        timew start "$selected"
        tmux set -g status-right "\
#[fg=#719cd6,bg=default]\
#[fg=#192330,bg=#719cd6]  #(echo \"#{pane_current_path}\" | awk -F/ '{ if (NF<=2) print \$NF; else print \$(NF-1)\"/\"\$NF; }') \
#[fg=#719cd6,bg=#9d79d6]#[fg=#192330,bg=#9d79d6] $selected #(timew | awk '/^ *Total/ {split(\$NF,t,\":\"); print t[1]*60+t[2]\" min\"}') \
#[fg=#9d79d6,bg=default]"
    fi
fi
