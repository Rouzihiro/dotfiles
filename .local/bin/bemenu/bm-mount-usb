#!/bin/sh
BEMENU="${HOME}/.local/bin/bemenu/bm-run"

# Function to list partitions for $BEMENU
list_partitions() {
    lsblk -o NAME,SIZE,FSTYPE,MOUNTPOINT -l | \
    grep -E 'sd[a-z][0-9]|nvme[0-9]n[0-9]p[0-9]' | \
    awk '{print NR") "$0}'
}

# Select partition via $BEMENU dropdown
select_partition() {
    selected=$(list_partitions | $BEMENU -i -l 10 -p "Select partition:")
    partition_num=$(echo "$selected" | awk -F')' '{print $1}')
    selected_partition=$(lsblk -o NAME -l | grep -E 'sd[a-z][0-9]|nvme[0-9]n[0-9]p[0-9]' | sed -n "${partition_num}p" | awk '{print $1}')

    if [ -z "$selected_partition" ]; then
        echo "Invalid selection. Exiting."
        exit 1
    fi
    echo "Selected partition: /dev/$selected_partition"
}

# Select action via $BEMENU dropdown
select_action() {
    action=$(echo -e "mount\nunmount\nremove" | $BEMENU -c -i -l 3 -p "Choose action for /dev/$selected_partition:")
}

# Perform action
partition_action() {
    case "$action" in
        mount)
            mount_point="$HOME/mount/usb"
            mkdir -p "$mount_point"

            fs_type=$(lsblk -o FSTYPE -n "/dev/$selected_partition")
            mount_status=$(lsblk -o MOUNTPOINT -n "/dev/$selected_partition")

            if [ -n "$mount_status" ]; then
                echo "Already mounted at $mount_status."
                exit 0
            fi

            echo "Mounting /dev/$selected_partition to $mount_point..."
            if [ "$fs_type" = "ntfs" ]; then
                sudo ntfs-3g "/dev/$selected_partition" "$mount_point" -o "uid=$(id -u),gid=$(id -g)" && \
                    echo "✅ NTFS partition mounted successfully at $mount_point." || \
                    echo "❌ Failed to mount NTFS partition."
            else
                sudo mount "/dev/$selected_partition" "$mount_point" -o "uid=$(id -u),gid=$(id -g)" && \
                    echo "✅ Partition mounted successfully at $mount_point." || \
                    echo "❌ Failed to mount partition."
            fi
            ;;
        unmount)
            echo "Unmounting /dev/$selected_partition..."
            sync && sudo umount "/dev/$selected_partition" && \
                echo "✅ Partition unmounted successfully." || \
                echo "❌ Failed to unmount partition."
            ;;
        remove)
            echo "Safely removing /dev/$selected_partition..."
            sync
            sudo umount "/dev/$selected_partition" 2>/dev/null
            sudo udisksctl power-off -b "/dev/$selected_partition" && \
                echo "✅ Partition safely removed. You can unplug it now." || \
                echo "❌ Failed to safely remove partition."
            ;;
        *)
            echo "Invalid action. Exiting."
            exit 1
            ;;
    esac
}

# Main
select_partition
select_action
partition_action
