#!/usr/bin/env bash
# rdr1-optimized.sh

set -euo pipefail

PROTON_DIR="$HOME/.steam/root/steamapps/common/Proton 10.0"
PROTON_BIN="$PROTON_DIR/proton"
GAME_DIR="/home/rey/mount/usb/Games/Red.Dead.Redemption"
GAME_EXE="RDR.exe"

# Validate paths
if [[ ! -f "$PROTON_BIN" ]]; then
    echo "‚ùå Proton not found at: $PROTON_BIN" >&2
    exit 1
fi

if [[ ! -f "$GAME_DIR/$GAME_EXE" ]]; then
    echo "‚ùå Game not found at: $GAME_DIR/$GAME_EXE" >&2
    exit 1
fi

export STEAM_COMPAT_CLIENT_INSTALL_PATH="$HOME/.steam/root"
export STEAM_COMPAT_DATA_PATH="$HOME/Games/proton/RDR_prefix"

# RDR1-specific optimizations
export MESA_VK_DEVICE_SELECT=1000001    # Apple M1 Vulkan
export FEX_TSO_ENABLED=1                # Critical for performance
export DXVK_ASYNC=1                     # Reduces stuttering
export DXVK_HUD=1                       # Show FPS and GPU info
export PROTON_LOG=0                     # Disable logging for performance

# Optional performance additions:
export DXVK_STATE_CACHE=1               # Cache shaders between launches
export mesa_glthread=true               # Threaded OpenGL support
export MESA_SHADER_CACHE_DIR="$HOME/.cache/mesa"

# Create cache directory
mkdir -p "$HOME/.cache/mesa"

echo "üéÆ Red Dead Redemption 1 - Apple Silicon Optimized"
echo "üñ•Ô∏è  Using Apple M1 Hardware Vulkan"
echo "‚ö° Performance optimizations enabled"
echo "üìä DXVK HUD active - check FPS in-game"

cd "$GAME_DIR"
"$PROTON_BIN" run "$GAME_EXE" -windowed -width 1280 -height 720
