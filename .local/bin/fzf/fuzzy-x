#!/usr/bin/env bash
TERMINAL="foot"   # Preferred terminal
FM_TUI="yazi"     # TUI file manager
FM_GUI="thunar"   # GUI file manager

# Pre-check all required commands
for cmd in fzf bat nvim; do
  command -v "$cmd" >/dev/null 2>&1 || { 
    echo >&2 "$cmd not found, please install it."; exit 1; 
  }
done

# Configuration variables
FZF_PREVIEW_CMD='bat --color=always --style=numbers --line-range=:500 {}'
FZF_PREVIEW_WINDOW='up:60%'

# Add folders to blacklist here
BLACKLIST_DIRS=(
  "$HOME/.config/BraveSoftware/"
	"$HOME/.config/BraveSoftware/Brave-Browser/"
)

# Build the find exclusion expression
FIND_EXCLUDES=()
for dir in "${BLACKLIST_DIRS[@]}"; do
  # Use -name pattern matching instead of -path for simplicity
  dir_name=$(basename "$dir")
  FIND_EXCLUDES+=(-name "$dir_name" -prune -o)
done

while true; do
  # Run find excluding blacklisted dirs
file=$(find . "${FIND_EXCLUDES[@]}" \( -type f -o -type l \) -print 2>/dev/null | fzf --ansi \
    --preview "$FZF_PREVIEW_CMD" \
    --preview-window="$FZF_PREVIEW_WINDOW")

  [[ -z "$file" ]] && break

  echo "Selected: $file"
  echo "1) Open with xdg-open (1, Enter or o)"
  echo "2) Edit with nvim (2 or e)"
  echo "3) Execute (3 or x)"
  echo "4) Open path in terminal (4 or s)"
  echo "5) Open path in TUI file manager (5 or t)"
  echo "6) Open path in GUI file manager (6 or g)"
  echo "7) Cancel (7, c, or Esc)"
  read -r -p "Choice: " -n1 choice
  echo ""

  case "${choice,,}" in
    ""|1|o)
      xdg-open "$file" 2>/dev/null || echo "Failed to open with xdg-open"
      ;;
    2|e)
      nvim "$file"
      ;;
    3|x)
      if [[ -x "$file" ]]; then
        (cd "$(dirname "$file")" && "./$(basename "$file")")
      else
        echo "File is not executable: $file"
      fi
      ;;
    4|s)
      if command -v "$TERMINAL" >/dev/null 2>&1; then
        dir_path=$(dirname "$file")
        case "$TERMINAL" in
          gnome-terminal) "$TERMINAL" --working-directory="$dir_path" & ;;
          kitty) "$TERMINAL" --directory="$dir_path" & ;;
          *) "$TERMINAL" -e bash -c "cd '$dir_path'; exec bash" & ;;
        esac
        echo "Opened $TERMINAL in: $dir_path"
      fi
      ;;
    5|t)
      if command -v "$FM_TUI" >/dev/null 2>&1 && command -v "$TERMINAL" >/dev/null 2>&1; then
        dir_path=$(dirname "$file")
        case "$TERMINAL" in
          gnome-terminal) "$TERMINAL" --working-directory="$dir_path" -- "$FM_TUI" & ;;
          kitty) "$TERMINAL" --directory="$dir_path" -- "$FM_TUI" & ;;
          *) "$TERMINAL" -e "$FM_TUI" "$dir_path" & ;;
        esac
      fi
      ;;
    6|g)
      if command -v "$FM_GUI" >/dev/null 2>&1; then
        dir_path=$(dirname "$file")
        "$FM_GUI" "$dir_path" &
      fi
      ;;
    7|c|$'\e')
      continue
      ;;
    *)
      echo "Invalid choice '$choice'"
      sleep 1
      continue
      ;;
  esac

  read -r -p "Press any key to continue..." -n1 -t 5
  echo
done
