#!/usr/bin/env bash
TERMINAL="foot"
FM_TUI="yazi"
FM_GUI="thunar"

# Pre-check all required commands
for cmd in fzf bat nvim gum; do
  command -v "$cmd" >/dev/null 2>&1 || { 
    gum style --foreground 196 --bold "$cmd not found, please install it."
    exit 1
  }
done

# Configuration variables
FZF_PREVIEW_CMD='bat --color=always --style=numbers --line-range=:500 {}'
FZF_PREVIEW_WINDOW='up:60%'

# Add folders to blacklist here
BLACKLIST_DIRS=(
  "$HOME/.config/BraveSoftware/"
  "$HOME/.config/BraveSoftware/Brave-Browser/"
)

# Build the find exclusion expression
FIND_EXCLUDES=()
for dir in "${BLACKLIST_DIRS[@]}"; do
  if [[ "$dir" == /* ]]; then
    rel_dir=$(realpath --relative-to="." "$dir" 2>/dev/null || echo "$dir")
    FIND_EXCLUDES+=(-path "./$rel_dir" -prune -o)
  else
    FIND_EXCLUDES+=(-path "$dir" -prune -o)
  fi
done

while true; do
  gum style --foreground 212 --bold "üîç Searching files..."
  
  # Run find excluding blacklisted dirs
  file=$(find . "${FIND_EXCLUDES[@]}" \( -type f -o -type l \) -print 2>/dev/null | fzf --ansi \
    --preview "$FZF_PREVIEW_CMD" \
    --preview-window="$FZF_PREVIEW_WINDOW")

  [[ -z "$file" ]] && break

  gum style --foreground 86 "Selected: $file"
  
  # Vertical options inside a clean box
  gum style --foreground 45 --border rounded --border-foreground 45 --padding "1 2" -- "
$(gum style --foreground 86 --bold 'Quick Actions:')

$(gum style --foreground 245 '  1 / Enter  üìÇ Open with xdg-open')
$(gum style --foreground 245 '  2 / e      üìù Edit with nvim')
$(gum style --foreground 245 '  3 / x      ‚ö° Execute')
$(gum style --foreground 245 '  4 / s      üíª Open in terminal')
$(gum style --foreground 245 '  5 / t      üìä Open in TUI file manager')
$(gum style --foreground 245 '  6 / g      üñºÔ∏è  Open in GUI file manager')
$(gum style --foreground 245 '  7 / c      ‚ùå Cancel')
"
  
  # Use gum input for single character input with style
  choice=$(gum input --placeholder "Press action key (1-7) or letter..." --char-limit 1 --prompt "‚û§ " --prompt.foreground 214)
  
  case "${choice,,}" in
    ""|1|o)
      if xdg-open "$file" 2>/dev/null; then
        gum style --foreground 46 "‚úÖ Opened successfully"
      else
        gum style --foreground 196 "‚ùå Failed to open with xdg-open"
      fi
      ;;
    2|e)
      nvim "$file"
      ;;
    3|x)
      if [[ -x "$file" ]]; then
        gum style --foreground 214 "‚ö° Executing..."
        (cd "$(dirname "$file")" && "./$(basename "$file")")
      else
        gum style --foreground 196 "‚ùå File is not executable: $file"
      fi
      ;;
    4|s)
      if command -v "$TERMINAL" >/dev/null 2>&1; then
        dir_path=$(dirname "$file")
        case "$TERMINAL" in
          gnome-terminal) "$TERMINAL" --working-directory="$dir_path" & ;;
          kitty) "$TERMINAL" --directory="$dir_path" & ;;
          *) "$TERMINAL" -e bash -c "cd '$dir_path'; exec bash" & ;;
        esac
        gum style --foreground 45 "üíª Opened $TERMINAL in: $dir_path"
      fi
      ;;
    5|t)
      if command -v "$FM_TUI" >/dev/null 2>&1 && command -v "$TERMINAL" >/dev/null 2>&1; then
        dir_path=$(dirname "$file")
        case "$TERMINAL" in
          gnome-terminal) "$TERMINAL" --working-directory="$dir_path" -- "$FM_TUI" & ;;
          kitty) "$TERMINAL" --directory="$dir_path" -- "$FM_TUI" & ;;
          *) "$TERMINAL" -e "$FM_TUI" "$dir_path" & ;;
        esac
      fi
      ;;
    6|g)
      if command -v "$FM_GUI" >/dev/null 2>&1; then
        dir_path=$(dirname "$file")
        "$FM_GUI" "$dir_path" &
        gum style --foreground 51 "üñºÔ∏è Opened $FM_GUI in: $dir_path"
      fi
      ;;
    7|c|$'\e'|*)
      gum style --foreground 245 "‚è≠Ô∏è  Continuing..."
      continue
      ;;
  esac

  gum style --foreground 245 --italic "Press any key to continue..."
  read -r -n1 -t 3
  echo
done
