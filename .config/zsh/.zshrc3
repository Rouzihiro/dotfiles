# ============================================
# Zinit Plugin Manager Setup (FIXED)
# ============================================
# Define Zinit directory
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"

# Auto-install if missing
if [[ ! -f "${ZINIT_HOME}/zinit.zsh" ]]; then
    bash -c "$(curl --fail --show-error --silent --location \
        https://raw.githubusercontent.com/zdharma-continuum/zinit/HEAD/scripts/install.sh)"
fi

# Load Zinit
source "${ZINIT_HOME}/zinit.zsh"
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

# ============================================
# Plugins (Clean & Fast)
# ============================================
# Syntax highlighting
zinit light zsh-users/zsh-syntax-highlighting

# Autosuggestions
zinit light zsh-users/zsh-autosuggestions

# Auto-complete
zinit light marlonrichert/zsh-autocomplete

# Essential OMZ plugins
zinit snippet OMZP::git
zinit snippet OMZP::sudo
zinit snippet OMZP::command-not-found

# OS Detection for package manager
if grep -qi 'fedora' /etc/os-release 2>/dev/null; then
    zinit snippet OMZP::dnf
elif grep -qi 'arch' /etc/os-release 2>/dev/null; then
    zinit snippet OMZP::archlinux
fi

# ============================================
# Completion System
# ============================================
autoload -Uz compinit 

# Create directory if needed
[[ -d ~/.config/zsh ]] || mkdir -p ~/.config/zsh

# zcompdump setup
for dump in ~/.config/zsh/zcompdump(N.mh+24); do
  compinit -d ~/.config/zsh/zcompdump
done
compinit -C -d ~/.config/zsh/zcompdump

# Git info in prompt
autoload -Uz vcs_info
precmd () { vcs_info }
_comp_options+=(globdots)

# Completion styles
zstyle ':completion:*' verbose true
zstyle ':completion:*:*:*:*:*' menu select
zstyle ':completion:*:default' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion:*' matcher-list \
                'm:{a-zA-Z}={A-Za-z}' \
                '+r:|[._-]=* r:|=*' \
                '+l:|=*'
zstyle ':completion:*:warnings' format "%B%F{red}No matches for:%f %F{magenta}%d%b"
zstyle ':completion:*:descriptions' format '%F{yellow}[-- %d --]%f'
zstyle ':vcs_info:*' formats ' %B%s-[%F{magenta}%f %F{yellow}%b%f]-'

# ============================================
# History Settings
# ============================================
export HISTFILE="${XDG_CACHE_HOME:-$HOME/.cache}/zsh/history"
mkdir -p "$(dirname "$HISTFILE")"

export HISTORY_IGNORE="(ls|ls -a|cd|clear|pwd|exit|cd -|cd ..)"
HISTSIZE=10000
SAVEHIST=10000

# History options
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_FIND_NO_DUPS
setopt INC_APPEND_HISTORY 
setopt SHARE_HISTORY
setopt hist_ignore_space
setopt hist_ignore_all_dups
setopt hist_save_no_dups
setopt hist_ignore_dups
setopt hist_find_no_dups

# ============================================
# PATH Setup
# ============================================
eval "$(dircolors -b ${HOME}/.config/zsh/.dircolors 2>/dev/null || dircolors -b)"
export PATH="$HOME/.local/bin:$HOME/.local/share/bob/nightly/bin:/usr/local/bin:$PATH:$HOME/.dotnet/tools"

# Add subfolders inside ~/.local/bin
for dir in "$HOME/.local/bin/"*/; do
    [ -d "$dir" ] && export PATH="$dir:$PATH"
done

export PATH="$HOME/.cargo/bin:$PATH"

# ============================================
# FZF
# ============================================
if command -v fzf >/dev/null 2>&1; then
    # Try different source locations
    for fzf_file in \
        /usr/share/fzf/key-bindings.zsh \
        /usr/share/doc/fzf/examples/key-bindings.zsh \
        /opt/homebrew/opt/fzf/shell/key-bindings.zsh; do
        if [[ -f "$fzf_file" ]]; then
            source "$fzf_file"
            break
        fi
    done
    
    # Fallback to generating
    if ! typeset -f fzf-cd-widget >/dev/null; then
        source <(fzf --zsh 2>/dev/null)
    fi
    
    bindkey -r '^[c'
    bindkey '^O' fzf-cd-widget
fi

# ============================================
# Git Commit Shortcut
# ============================================
git_commit_with_message() {
  local msg=$BUFFER
  BUFFER="git add --all && git commit --message \"${msg}\""
  zle accept-line
}
zle -N git_commit_with_message
bindkey "^G" git_commit_with_message

# ============================================
# SSH Agent Setup
# ============================================
export SSH_AUTH_SOCK="${XDG_RUNTIME_DIR}/ssh-agent.socket"
if ! pgrep -u "$USER" ssh-agent >/dev/null 2>&1; then
    eval "$(ssh-agent -a "$SSH_AUTH_SOCK")" >/dev/null
fi
if ! ssh-add -l >/dev/null 2>&1; then
    ssh-add ~/.ssh/id_github 2>/dev/null
    ssh-add ~/.ssh/id_ftp 2>/dev/null
    ssh-add ~/.ssh/id_openweather 2>/dev/null
fi

# ============================================
# Starship Prompt
# ============================================
if command -v starship >/dev/null 2>&1; then
    eval "$(starship init zsh)"
fi

# ============================================
# Sudo Prompt
# ============================================
export SUDO_PROMPT="%F{red}[sudo] %F{yellow}password for %n  :%f"

# ============================================
# Autosuggest Strategy
# ============================================
ZSH_AUTOSUGGEST_STRATEGY=(history completion)

# ============================================
# Completion Dots Animation
# ============================================
expand-or-complete-with-dots() {
  echo -n "\e[31m…\e[0m"
  zle expand-or-complete
  zle redisplay
}
zle -N expand-or-complete-with-dots
bindkey "^I" expand-or-complete-with-dots

# ============================================
# Shell Options
# ============================================
stty stop undef
setopt interactive_comments
setopt AUTOCD
setopt PROMPT_SUBST
setopt MENU_COMPLETE
setopt LIST_PACKED
setopt AUTO_LIST
setopt COMPLETE_IN_WORD

# ============================================
# Vi Mode with Cursor Change
# ============================================
bindkey -v
export KEYTIMEOUT=1
function zle-keymap-select () {
    case $KEYMAP in
        vicmd) echo -ne '\e[1 q';;  # block cursor
        viins|main) echo -ne '\e[5 q';; # beam cursor
    esac
}
zle -N zle-keymap-select
zle-line-init(){
    zle -K viins
    echo -ne "\e[5 q"
}
zle -N zle-line-init
echo -ne '\e[5 q'
preexec() { echo -ne '\e[5 q' ;}

# Vi mode keybindings
bindkey '^j' history-search-backward
bindkey '^k' history-search-forward
bindkey '^[w' kill-region
bindkey '^y' autosuggest-accept
bindkey -v '^?' backward-delete-char

# ============================================
# Zoxide
# ============================================
if command -v zoxide >/dev/null 2>&1; then
    eval "$(zoxide init --cmd cd zsh)"
fi

# ============================================
# Load Aliases
# ============================================
for file in "${ZDOTDIR:-$HOME/.config/zsh}"/.aliases*; do
    [ -f "$file" ] && source "$file"
done

# ============================================
# Sway Autostart
# ============================================
[ "$(tty)" = "/dev/tty1" ] && exec sway

# Load a few important annexes, without Turbo
# (this is currently required for annexes)
zinit light-mode for \
    zdharma-continuum/zinit-annex-as-monitor \
    zdharma-continuum/zinit-annex-bin-gem-node \
    zdharma-continuum/zinit-annex-patch-dl \
    zdharma-continuum/zinit-annex-rust

### End of Zinit's installer chunk
