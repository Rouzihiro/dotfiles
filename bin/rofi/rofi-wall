#!/usr/bin/env bash

# Configuration
walldir="$HOME/Pictures/wallpapers/"
lines=5
columns=10
icons_size=128
width=$((columns * icons_size / 8))
swaybg_pid_file="$XDG_RUNTIME_DIR/swaybg.pid"  # For PID tracking

# Rofi theme
theme="window { width: ${width}ch; }
      listview { lines: ${lines}; columns: ${columns}; cycle:true; spacing:5px;}
      element { padding:0px; margin:0px; }
      element-icon { size: ${icons_size}px; }
      element-text { text-color: rgba(0,0,0,0%); }"

# Wallpaper selection
selected=$(find -L "$walldir" -type f |
  while read -r A; do echo -en "$A\x00icon\x1f$A\n"; done |
  rofi -dmenu \
    -show-icons \
    -p "Wallpaper" \
    -theme-str "${theme}")

# Set wallpaper if selected
if [[ -n "$selected" ]]; then
    # Kill previous swaybg instance if exists
    if [[ -f "$swaybg_pid_file" ]]; then
        old_pid=$(cat "$swaybg_pid_file")
        kill "$old_pid" 2>/dev/null
    fi

    # Set new wallpaper and store PID
    swaybg -i "$selected" -m fill &
    echo $! > "$swaybg_pid_file"
fi
